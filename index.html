<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="$views/css/image.css">
        <link rel="stylesheet" href="$views/css/list.css">
        <link rel="stylesheet" href="$views/css/buttons.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/github.css">
        <script src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js'></script>

        <script language="javascript">
        catalog = ""
        var catalogArray = new Array();

        $(function(){                 
          $(".catalogLoader").click(function(){
            $.getJSON( "http://api.discogs.com/users/OjoDeGato/collection/folders/0/releases", function(data){   
                 $.each(data.releases, function(i,release) {
                   catalog += release.basic_information.title+" - "+release.basic_information.artists[0].name+"<br/>";
                   catalogArray.push(release.basic_information.title+" - "+release.basic_information.artists[0].name);
                   }); 				   
                   // Search album URI for albums found in the catalog
                   require(['$api/search#Search','$api/models'], function(Search, models) {				   
						// Create and add to a var the playlist
				   		models.Playlist.create("OjoDeGato´s collection").done(function(loadedPlaylist) {
							playlist = loadedPlaylist
						});							
						// Iterate over all the albums-artist save from discogs
						catalogArray.forEach(function(catalogAlbum) {	
							// Get all the possible albums (just getting the first)
							var search = Search.search(catalogAlbum);
							search.albums.snapshot(0, 1).done(function(snapshot) {
								//console.log('Found', snapshot.length, 'result(s) for', search.query);
								snapshot.loadAll('name').done(function(albums) {
									// TODO: Just take first so it´s not neccesary
									albums.forEach(function(album) {
										// Add tracks to playlist and populate
										playlist.load("tracks").done(function(loadedPlaylist) {
											album = models.Album.fromURI(album);
											// Populate the playlist with the tracks for the album
											album.load("tracks").done(function(albumlist) {
												albumlist.tracks.snapshot().done(function(snapshot) {
													for (var i = 0, l = snapshot.length; i < l; i++) {
														var track = snapshot.get(i);
														// Add all the tracks to the playlist
														addIfNotDuplicate(track.uri,loadedPlaylist,models);
													}
												});
											});
										});
									});
								});
							});
						});
                    $("#userCatalog").replaceWith("<br/>"+catalog);
               });                         
			});  
          });
        });
		
		function addIfNotDuplicate(newUri,playlist,models)
		{
			playlist.tracks.snapshot().done(function(snapshot) {
				duplicate = false;
				for (var i = 0, l = snapshot.length; i < l; i++) {
					var track = snapshot.get(i);
					if (track == newUri){
						console.log("Duplicate: "+track);
						duplicate = true;
					}
				}
				
				console.log(duplicate);
				if (duplicate == false){
					playlist.tracks.add(models.Track.fromURI(newUri));
				}
			});
		}
		
        </script>

    </head>
    <body>
        <div id="wrapper">
            <img src='http://s.pixogs.com/images/discogs-white.png?3'></img>

            <div id='container'>
                <input type="button" class="catalogLoader" value="load Discogs">
                <div id='userCatalog'>
                    <h1>Get a playlist from a discogs´s user catalog!</h1>
                    <p>Just push the botton to get the user: OjoDeGato</p>
                </div>
            </div>
        </div>

    </body>
</html>
