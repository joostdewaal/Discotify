<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="css/main.css">
		<link rel="stylesheet" href="$views/css/throbber.css">
        <script src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js'></script>

        <script language="javascript">
		
		$(function main(){                 
			$(".catalogLoader").click(function(){
			  loadPlaylist();
			}); 
		})

		function loadPlaylist(){
			catalog = ""
			catalogArray = new Array();
			userName = document.getElementById("userName").value

			$.getJSON("http://api.discogs.com/users/"+userName.toLowerCase()+"/collection/folders/0/releases?per_page=100").done(function(data){ 
				$.each(data.releases, function(i,release) {
					catalog += "<a href=http://www.discogs.com/release/"+release.basic_information.resource_url.split("/")[4]+">"+release.basic_information.artists[0].name+" - "+release.basic_information.title+"<br/></a>";
					catalogArray.push(release.basic_information.title+" - "+release.basic_information.artists[0].name);
				}); 	
				
				require(['$api/search#Search','$api/models','$api/library#Library', '$views/throbber#Throbber'], function(Search, models, Library, Throbber) {				
					
					// Show the throbber in the loading process
					catalogContentDiv = document.getElementById('catalogContent');
					throbber = Throbber.forElement(catalogContentDiv);
					throbber.show();
					
					exists = false;					
					// Check if the user have the playlist and return a new or find playlist object
					returnedLibrary = Library.forCurrentUser();
					returnedLibrary.playlists.snapshot().done(function(snapshot) {
						for (var i = 0, l = snapshot.length; i < l; i++) {
						  var playlist = snapshot.get(i);
						  if (playlist.name == userName.toLowerCase()+"´s collection"){
							playlist = models.Playlist.fromURI(playlist.uri);
							exists = true;
							getAlbumsFromCatalog(Search,models,playlist,deferred);
							break;
						  }
						}
						if (exists == false){
							models.Playlist.create(userName.toLowerCase()+"´s collection").done(function(createPlaylist) {
								playlist = createPlaylist
								getAlbumsFromCatalog(Search,models,playlist,deferred))
							});
						}

						$("#userCatalog").html(" ");
						$("#userCatalog").append("<br/>"+catalog);
						throbber.hide();
					});										
			   });                         
			})
			.fail(function(error){
				$("#userCatalog").html(" ");
				$("#userCatalog").append("Sorry, we can´t access to this user collection!");
			});
        };
	
		function getAlbumsFromCatalog(Search,models,playlist,deferred)
		{
			// Iterate over all the albums-artist save from discogs
			catalogArray.forEach(function(catalogAlbum) {	
				// Get all the possible albums (just getting the first)
				var search = Search.search(catalogAlbum);
				search.albums.snapshot(0,1).done(function(snapshot) {
					snapshot.loadAll('name').done(function(albums) {					
						loadAlbums(albums,playlist,models);
					});
				});
			});
		}
		
		function loadAlbums(albums,playlist,models)
		{
			// Add tracks to playlist and populate
			playlist.load("tracks").done(function(loadedPlaylist) {
				loadedPlaylist.tracks.snapshot().done(function(playListsnapshot) {			
					albums.forEach(function(album) {
						//console.log(album);						
						album = models.Album.fromURI(album);
						// Populate the playlist with the tracks for the album
						album.load("tracks").done(function(albumlist) {
							albumlist.tracks.snapshot().done(function(albumSnapshot) {									
								addAlbumSongsToPlaylist(playlistSnapshot,albumSnapshot,loadedPlaylist,models)
							});
						});
					});
				});
			});
		}
		
		function addAlbumSongsToPlaylist(playlistSnapshot,albumSnapshot,loadedPlaylist,models)
		{
			for (var i = 0, l = albumSnapshot.length; i < l; i++) {
				var track = albumSnapshot.get(i);
				if (!playlistSnapshot.find(track)){
					console.log("canción nueva");
					playlist.tracks.add(models.Track.fromURI(track.uri));
				}			
			}
		}	
		
        </script>

    </head>
    <body>
        <div id="wrapper">
            <div id='container'>
			
                <div id='title'>
                    <h1>Discotify!</h1>
                    <h2>Get a playlist from a discogs´s user catalog</h2>
                </div>
				
				<div id='search'>
					<img id="discotifyImg" src='http://s.pixogs.com/images/discogs-white.png?3'></img>
					<form id="userSearch">
						<input type="text" id="userName" class="userSearchInput" name="q" size="21" maxlength="120"> <input type="button" class="catalogLoader" value=">">
					</form>	 
				</div>
				<div id='catalogContent'>
					<div id='userCatalog'></div>				
				</div>
            </div>
        </div>

    </body>
</html>
